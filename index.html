<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TeachApp: Student Attendance</title>
    
    <!-- PWA enhancements -->
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Load Babel for JSX/TS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.1.1/",
    "react/": "https://esm.sh/react@^19.1.1/",
    "@google/genai": "https://esm.sh/@google/genai@^1.14.0"
  }
}
</script>
</head>
  <body class="bg-slate-100">
    <div id="root"></div>
    <script type="text/babel">
      // --- Start of Consolidated Code ---
      const { useState, useEffect, createContext, useContext, useMemo, useCallback, useRef } = React;

      // --- From components/Icons.tsx ---
      const PlusIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );
      const TrashIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );
      const EditIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
      );
      const ChevronLeftIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      );
      const UsersIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      );
      const CalendarIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      );
      const CheckSquareIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <polyline points="9 11 12 14 22 4"></polyline>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
      );
      const RefreshCwIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <path d="M3 2v6h6"></path>
              <path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path>
              <path d="M21 22v-6h-6"></path>
              <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path>
          </svg>
      );
      const UploadIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
      );
      const DownloadIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
      );

      // --- From components/Modal.tsx ---
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;
        return (
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"
            onClick={onClose}
          >
            <div 
              className="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex justify-between items-center border-b pb-3 mb-4">
                <h2 className="text-xl font-semibold text-gray-800">{title}</h2>
                <button 
                  onClick={onClose}
                  className="text-gray-500 hover:text-gray-800"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
              <div>
                {children}
              </div>
            </div>
          </div>
        );
      };

      // --- From services/geminiService.ts ---
      const MOCK_DATA = [
          {
              id: "c1", name: "Lớp 10A1", schedule: "Thứ 2, 4, 6 - 7:00 AM",
              students: [
                  { id: "s1", name: "Nguyễn Văn An", generalNotes: "", attendance: [] },
                  { id: "s2", name: "Trần Thị Bình", generalNotes: "", attendance: [] },
                  { id: "s3", name: "Lê Văn Cường", generalNotes: "", attendance: [{id: "a1", date: "2024-05-20", note: "Vắng có phép"}]}
              ]
          },
          {
              id: "c2", name: "Lớp 11B2", schedule: "Thứ 3, 5, 7 - 1:00 PM",
              students: [
                  { id: "s4", name: "Phạm Thị Dung", generalNotes: "Năng nổ", attendance: [] },
                  { id: "s5", name: "Hoàng Văn Em", generalNotes: "", attendance: [] }
              ]
          }
      ];
      
      const generateInitialData = async () => {
        // Simplified to always return mock data as API_KEY is not available on client-side GitHub pages
        console.warn("Using mock data because app is running in browser without server-side API key.");
        return MOCK_DATA;
      };
      
      // --- Helper for sorting Vietnamese names ---
      const vietnameseNameSort = (a, b) => {
          const getName = (fullName) => {
              const parts = fullName.trim().split(' ');
              return parts.length > 0 ? parts[parts.length - 1] : '';
          };
          const nameA = getName(a.name);
          const nameB = getName(b.name);
          const comparison = nameA.localeCompare(nameB, 'vi');
          if (comparison !== 0) {
              return comparison;
          }
          return a.name.localeCompare(b.name, 'vi'); // Fallback to full name comparison
      };

      // --- From context/AppContext.tsx ---
      const AppContext = createContext(undefined);
      const AppProvider = ({ children }) => {
        const [classrooms, setClassrooms] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);
        const [view, setView] = useState({ page: 'main' });

        useEffect(() => {
          const loadData = async () => {
            try {
              setIsLoading(true);
              const savedData = localStorage.getItem('teachapp_data');
              if (savedData) {
                setClassrooms(JSON.parse(savedData));
              } else {
                const initialData = await generateInitialData();
                setClassrooms(initialData);
              }
              setError(null);
            } catch (e) {
              setError("Không thể tải dữ liệu đã lưu. Dữ liệu có thể bị hỏng.");
              console.error(e);
            } finally {
              setIsLoading(false);
            }
          };
          loadData();
        }, []);

        useEffect(() => {
          if (!isLoading) {
            localStorage.setItem('teachapp_data', JSON.stringify(classrooms));
          }
        }, [classrooms, isLoading]);

        const navigateHome = () => setView({ page: 'main' });
        const navigateToClass = (classId) => setView({ page: 'classDetails', classId });
        const navigateToStudent = (classId, studentId) => setView({ page: 'studentDetails', classId, studentId });

        const addClassroom = (name, schedule) => {
          const newClass = { id: crypto.randomUUID(), name, schedule, students: [] };
          setClassrooms(prev => [...prev, newClass]);
        };
        const updateClassroom = (id, name, schedule) => {
          setClassrooms(prev => prev.map(c => c.id === id ? { ...c, name, schedule } : c));
        };
        const deleteClassroom = (id) => {
          setClassrooms(prev => prev.filter(c => c.id !== id));
          navigateHome();
        };
        const addStudent = (classId, name) => {
          const newStudent = { id: crypto.randomUUID(), name, generalNotes: "", attendance: [] };
          setClassrooms(prev => prev.map(c => {
              if (c.id === classId) {
                  const updatedStudents = [...c.students, newStudent].sort(vietnameseNameSort);
                  return { ...c, students: updatedStudents };
              }
              return c;
          }));
        };
        const updateStudent = (classId, studentId, name, generalNotes) => {
          setClassrooms(prev => prev.map(c => {
            if (c.id === classId) {
              const updatedStudents = c.students.map(s => 
                s.id === studentId ? { ...s, name, generalNotes } : s
              ).sort(vietnameseNameSort);
              return { ...c, students: updatedStudents };
            }
            return c;
          }));
        };
        const deleteStudent = (classId, studentId) => {
          setClassrooms(prev => prev.map(c => {
            if (c.id === classId) {
              return { ...c, students: c.students.filter(s => s.id !== studentId) };
            }
            return c;
          }));
        };
        const addAttendanceRecords = (classId, studentIds, date, note) => {
            setClassrooms(prev => prev.map(c => {
                if (c.id === classId) {
                    const updatedStudents = c.students.map(s => {
                        if (studentIds.includes(s.id)) {
                            const newRecord = { id: crypto.randomUUID(), date, note };
                            if (!s.attendance.some(a => a.date === date)) {
                                return { ...s, attendance: [...s.attendance, newRecord] };
                            }
                        }
                        return s;
                    });
                    return { ...c, students: updatedStudents };
                }
                return c;
            }));
        };
        const addSingleAttendanceRecord = (classId, studentId, date, note) => {
            addAttendanceRecords(classId, [studentId], date, note);
        };
        const updateAttendanceRecord = (classId, studentId, recordId, date, note) => {
            setClassrooms(prev => prev.map(c => {
                if (c.id === classId) {
                    const updatedStudents = c.students.map(s => {
                        if (s.id === studentId) {
                            const updatedAttendance = s.attendance.map(a => 
                                a.id === recordId ? { ...a, date, note } : a
                            );
                            return { ...s, attendance: updatedAttendance };
                        }
                        return s;
                    });
                    return { ...c, students: updatedStudents };
                }
                return c;
            }));
        };
        const deleteAttendanceRecord = (classId, studentId, recordId) => {
            setClassrooms(prev => prev.map(c => {
                if (c.id === classId) {
                    const updatedStudents = c.students.map(s => {
                        if (s.id === studentId) {
                            return { ...s, attendance: s.attendance.filter(a => a.id !== recordId) };
                        }
                        return s;
                    });
                    return { ...c, students: updatedStudents };
                }
                return c;
            }));
        };

        const setAttendanceForDate = (classId, absentStudentIds, date, note) => {
            setClassrooms(prev => prev.map(c => {
                if (c.id !== classId) return c;

                const updatedStudents = c.students.map(student => {
                    const isMarkedAbsent = absentStudentIds.includes(student.id);
                    const existingRecord = student.attendance.find(a => a.date === date);

                    if (isMarkedAbsent) {
                        if (existingRecord) {
                            if (existingRecord.note !== note) {
                                const updatedAttendance = student.attendance.map(a => 
                                    a.id === existingRecord.id ? { ...a, note } : a
                                );
                                return { ...student, attendance: updatedAttendance };
                            }
                        } else {
                            const newRecord = { id: crypto.randomUUID(), date, note };
                            return { ...student, attendance: [...student.attendance, newRecord] };
                        }
                    } else {
                        if (existingRecord) {
                            const updatedAttendance = student.attendance.filter(a => a.date !== date);
                            return { ...student, attendance: updatedAttendance };
                        }
                    }
                    return student;
                });
                
                return { ...c, students: updatedStudents };
            }));
        };

        const exportData = () => {
          try {
            if (classrooms.length === 0) {
              alert("Không có dữ liệu để xuất.");
              return;
            }
            const jsonString = JSON.stringify(classrooms, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().slice(0, 10);
            link.download = `teachapp_backup_${date}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error("Lỗi khi xuất dữ liệu:", error);
            alert("Đã xảy ra lỗi khi xuất dữ liệu.");
          }
        };

        const importData = (jsonString) => {
          if (!window.confirm("Bạn có chắc muốn nhập dữ liệu không? Dữ liệu hiện tại sẽ bị ghi đè.")) {
            return;
          }
          try {
            const data = JSON.parse(jsonString);
            if (Array.isArray(data) && (data.length === 0 || data.every(c => c.id && c.name && Array.isArray(c.students)))) {
              setClassrooms(data);
              alert("Nhập dữ liệu thành công!");
              navigateHome();
            } else {
              throw new Error("Định dạng tệp không hợp lệ.");
            }
          } catch (error) {
            console.error("Lỗi khi nhập dữ liệu:", error);
            alert("Đã xảy ra lỗi khi nhập dữ liệu. Vui lòng kiểm tra định dạng tệp.");
          }
        };

        const importStudents = (classId, studentNames) => {
            setClassrooms(prev => prev.map(c => {
                if (c.id === classId) {
                    const existingStudentNames = new Set(c.students.map(s => s.name.toLowerCase().trim()));
                    const newStudents = studentNames
                        .map(name => name.trim())
                        .filter(name => name.length > 0)
                        .filter(name => !existingStudentNames.has(name.toLowerCase()))
                        .map(name => ({ id: crypto.randomUUID(), name, generalNotes: "", attendance: [] }));

                    if (newStudents.length > 0) {
                        setTimeout(() => alert(`${newStudents.length} học sinh mới đã được thêm vào lớp.`), 100);
                    } else {
                        setTimeout(() => alert("Không có học sinh mới nào được thêm. Các học sinh trong tệp có thể đã tồn tại trong lớp."), 100);
                    }
                    
                    const updatedStudentList = [...c.students, ...newStudents].sort(vietnameseNameSort);
                    return { ...c, students: updatedStudentList };
                }
                return c;
            }));
        };

        const value = { classrooms, isLoading, error, view, navigateHome, navigateToClass, navigateToStudent, addClassroom, updateClassroom, deleteClassroom, addStudent, updateStudent, deleteStudent, addAttendanceRecords, addSingleAttendanceRecord, updateAttendanceRecord, deleteAttendanceRecord, setAttendanceForDate, exportData, importData, importStudents };
        return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
      };
      const useAppContext = () => {
        const context = useContext(AppContext);
        if (context === undefined) {
          throw new Error('useAppContext must be used within an AppProvider');
        }
        return context;
      };

      // --- From pages/MainPage.tsx ---
      const ClassroomModal = ({ classroom, onClose }) => {
          const { addClassroom, updateClassroom } = useAppContext();
          const [name, setName] = useState(classroom?.name || '');
          const [schedule, setSchedule] = useState(classroom?.schedule || '');
          const handleSubmit = () => {
              if (name.trim() && schedule.trim()){
                  if(classroom) {
                      updateClassroom(classroom.id, name, schedule);
                  } else {
                      addClassroom(name, schedule);
                  }
                  onClose();
              }
          };
          return (
              <Modal isOpen={true} onClose={onClose} title={classroom ? "Sửa thông tin lớp" : "Thêm lớp mới"}>
                  <div className="space-y-4">
                      <div>
                          <label htmlFor="className" className="block text-sm font-medium text-gray-700 mb-1">Tên lớp</label>
                          <input type="text" id="className" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Ví dụ: Lớp 10A1"/>
                      </div>
                      <div>
                          <label htmlFor="classSchedule" className="block text-sm font-medium text-gray-700 mb-1">Lịch học</label>
                          <input type="text" id="classSchedule" value={schedule} onChange={e => setSchedule(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Ví dụ: Thứ 2, 4, 6 - 7:00 AM"/>
                      </div>
                      <div className="flex justify-end space-x-2 pt-2">
                          <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Hủy</button>
                          <button onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button>
                      </div>
                  </div>
              </Modal>
          );
      };
      const ClassroomCard = ({ classroom }) => {
        const { navigateToClass, deleteClassroom } = useAppContext();
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);
        const handleDelete = (e) => {
          e.stopPropagation();
          if(window.confirm(`Bạn có chắc muốn xoá lớp "${classroom.name}" không? Mọi dữ liệu học sinh sẽ bị mất.`)){
            deleteClassroom(classroom.id);
          }
        };
        const handleEdit = (e) => {
          e.stopPropagation();
          setIsEditModalOpen(true);
        };
        return (
          <>
            <div onClick={() => navigateToClass(classroom.id)} className="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer p-5 flex flex-col justify-between border-l-4 border-blue-500">
              <div>
                  <h2 className="text-xl font-bold text-gray-800 truncate">{classroom.name}</h2>
                  <div className="text-gray-600 mt-2 space-y-1 text-sm">
                      <div className="flex items-center">
                          <UsersIcon className="w-4 h-4 mr-2 text-gray-500"/>
                          <span>Sĩ số: {classroom.students.length}</span>
                      </div>
                      <div className="flex items-center">
                          <CalendarIcon className="w-4 h-4 mr-2 text-gray-500"/>
                          <span>Lịch học: {classroom.schedule}</span>
                      </div>
                  </div>
              </div>
              <div className="flex justify-end space-x-2 mt-4">
                  <button onClick={handleEdit} className="p-2 text-gray-500 hover:text-blue-600"><EditIcon className="w-5 h-5"/></button>
                  <button onClick={handleDelete} className="p-2 text-gray-500 hover:text-red-600"><TrashIcon className="w-5 h-5"/></button>
              </div>
            </div>
            {isEditModalOpen && <ClassroomModal classroom={classroom} onClose={() => setIsEditModalOpen(false)} />}
          </>
        );
      };
      const MainPage = () => {
        const { classrooms, exportData, importData } = useAppContext();
        const [isModalOpen, setIsModalOpen] = useState(false);
        const fileInputRef = useRef(null);

        const handleImportClick = () => {
            fileInputRef.current.click();
        };

        const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    importData(content);
                } catch (error) {
                    console.error("Lỗi đọc tệp:", error);
                    alert("Không thể đọc tệp đã chọn.");
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        };

        return (
          <div className="p-4 sm:p-6 lg:p-8">
              <header className="flex justify-between items-center mb-6 flex-wrap gap-2">
                  <h1 className="text-3xl font-bold text-gray-800">Danh sách Lớp học</h1>
                   <div className="flex gap-2 flex-wrap justify-end">
                        <button onClick={handleImportClick} className="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors">
                            <UploadIcon className="w-5 h-5 mr-2"/>
                            Nhập dữ liệu
                        </button>
                        <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json,application/json" style={{ display: 'none' }} />
                        <button onClick={exportData} className="flex items-center bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition-colors">
                            <DownloadIcon className="w-5 h-5 mr-2"/>
                            Xuất dữ liệu
                        </button>
                        <button onClick={() => setIsModalOpen(true)} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            <PlusIcon className="w-5 h-5 mr-2"/>
                            Thêm lớp
                        </button>
                    </div>
              </header>
              {classrooms.length > 0 ? (
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {classrooms.map(c => <ClassroomCard key={c.id} classroom={c} />)}
                  </div>
              ) : (
                  <div className="text-center py-16 px-6 bg-white rounded-lg shadow-md">
                      <h3 className="text-xl font-semibold text-gray-700">Chưa có lớp học nào</h3>
                      <p className="text-gray-500 mt-2">Bắt đầu bằng cách thêm lớp học đầu tiên của bạn.</p>
                      <button onClick={() => setIsModalOpen(true)} className="mt-6 flex items-center mx-auto bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-blue-700 transition-colors">
                          <PlusIcon className="w-5 h-5 mr-2"/>
                          Thêm lớp ngay
                      </button>
                  </div>
              )}
              {isModalOpen && <ClassroomModal onClose={() => setIsModalOpen(false)} />}
          </div>
        );
      };

      // --- From pages/StudentListPage.tsx ---
      const StudentListPage = ({ classId }) => {
        const { classrooms, navigateHome, navigateToStudent, addStudent, deleteStudent, setAttendanceForDate, importStudents } = useAppContext();
        const classroom = useMemo(() => classrooms.find(c => c.id === classId), [classrooms, classId]);
        const [selectedStudentIds, setSelectedStudentIds] = useState([]);
        const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
        const [attendanceNote, setAttendanceNote] = useState('');
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [newStudentName, setNewStudentName] = useState('');
        const studentFileInputRef = useRef(null);

        useEffect(() => {
          if (classroom) {
              const absentStudents = classroom.students.filter(student => 
                  student.attendance.some(record => record.date === attendanceDate)
              );
              
              setSelectedStudentIds(absentStudents.map(student => student.id));
  
              const noteToDisplay = absentStudents[0]?.attendance.find(rec => rec.date === attendanceDate)?.note || '';
              setAttendanceNote(noteToDisplay);
          }
        }, [attendanceDate, classroom]);


        if (!classroom) {
          return <div className="p-4 text-center text-red-500">Lớp học không tìm thấy.</div>;
        }
        
        const handleSelectStudent = (studentId) => {
          setSelectedStudentIds(prev =>
            prev.includes(studentId)
              ? prev.filter(id => id !== studentId)
              : [...prev, studentId]
          );
        };
        const handleSelectAll = () => {
          if (selectedStudentIds.length === classroom.students.length) {
            setSelectedStudentIds([]);
          } else {
            setSelectedStudentIds(classroom.students.map(s => s.id));
          }
        };
        const handleInvertSelection = () => {
          const allIds = classroom.students.map(s => s.id);
          setSelectedStudentIds(allIds.filter(id => !selectedStudentIds.includes(id)));
        };
        const handleAddStudent = () => {
          if (newStudentName.trim()) {
            addStudent(classId, newStudentName.trim());
            setNewStudentName('');
            setIsModalOpen(false);
          }
        };
        const handleDeleteSelected = () => {
          if (selectedStudentIds.length === 0) return;
          if (window.confirm(`Bạn có chắc muốn xoá ${selectedStudentIds.length} học sinh đã chọn?`)) {
            selectedStudentIds.forEach(id => deleteStudent(classId, id));
            setSelectedStudentIds([]);
          }
        };
        const handleSaveAttendance = () => {
          if (selectedStudentIds.length > 0 && !attendanceNote.trim()) {
              alert("Vui lòng nhập ghi chú cho học sinh vắng.");
              return;
          }
          setAttendanceForDate(classId, selectedStudentIds, attendanceDate, attendanceNote);
          alert('Đã lưu điểm danh thành công!');
        };

        const handleImportStudentsClick = () => {
            studentFileInputRef.current.click();
        };

        const handleStudentFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const names = content.split('\n').map(name => name.trim()).filter(Boolean);
                    if (names.length > 0) {
                        importStudents(classId, names);
                    } else {
                        alert("Tệp rỗng hoặc không hợp lệ.");
                    }
                } catch (error) {
                    console.error("Lỗi khi đọc tệp:", error);
                    alert("Đã xảy ra lỗi khi đọc tệp.");
                }
            };
            reader.onerror = () => {
                 alert("Không thể đọc tệp.");
            };
            reader.readAsText(file);
            event.target.value = null;
        };

        return (
          <div className="p-4 sm:p-6 lg:p-8">
            <header className="flex items-center justify-between mb-4">
              <button onClick={navigateHome} className="flex items-center text-blue-600 hover:text-blue-800 font-medium">
                <ChevronLeftIcon className="w-5 h-5 mr-1" />
                Tất cả lớp học
              </button>
            </header>
            <div className="bg-white p-6 rounded-lg shadow-md mb-24">
              <div className="border-b pb-4 mb-4">
                <h1 className="text-3xl font-bold text-gray-800">{classroom.name}</h1>
                <p className="text-gray-500">Sĩ số: {classroom.students.length}</p>
              </div>
              <div className="flex flex-wrap gap-2 items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg">
                <div className="flex flex-wrap gap-2">
                    <button onClick={handleSelectAll} className="flex items-center px-3 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300"><CheckSquareIcon className="w-4 h-4 mr-1" /> Chọn tất cả</button>
                    <button onClick={handleInvertSelection} className="flex items-center px-3 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300"><RefreshCwIcon className="w-4 h-4 mr-1" /> Đảo ngược chọn</button>
                </div>
                <input type="file" ref={studentFileInputRef} onChange={handleStudentFileChange} accept=".txt,text/plain" style={{ display: 'none' }} />
              </div>
              
              <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                      <div className="md:col-span-1">
                          <label htmlFor="attendance-date" className="block text-sm font-medium text-gray-700 mb-1">Ngày điểm danh</label>
                          <input type="date" id="attendance-date" value={attendanceDate} onChange={e => setAttendanceDate(e.target.value)} className="p-2 border border-gray-300 rounded-md w-full"/>
                      </div>
                      <div className="md:col-span-2">
                          <label htmlFor="attendance-note" className="block text-sm font-medium text-gray-700 mb-1">
                              Ghi chú cho học sinh vắng ({selectedStudentIds.length})
                          </label>
                          <input 
                              id="attendance-note" 
                              type="text" 
                              value={attendanceNote} 
                              onChange={e => setAttendanceNote(e.target.value)} 
                              placeholder="Ví dụ: Vắng có phép" 
                              className="w-full p-2 border border-gray-300 rounded-md"
                              disabled={selectedStudentIds.length === 0}
                          />
                      </div>
                  </div>
                  <div className="flex justify-end">
                      <button onClick={handleSaveAttendance} className="flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                          Lưu điểm danh
                      </button>
                  </div>
              </div>
              
              <ul className="space-y-2">
                {[...classroom.students].sort(vietnameseNameSort).map(student => (
                  <li key={student.id} className="flex items-center p-3 rounded-md hover:bg-gray-100 transition-colors duration-150">
                    <input type="checkbox" checked={selectedStudentIds.includes(student.id)} onChange={() => handleSelectStudent(student.id)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-4"/>
                    <div className="flex-grow cursor-pointer" onClick={() => navigateToStudent(classId, student.id)}>
                      <p className="font-semibold text-gray-800">{student.name}</p>
                      <p className="text-sm text-gray-500">Số buổi có ghi chú: {student.attendance.length}</p>
                    </div>
                  </li>
                ))}
                {classroom.students.length === 0 && <p className="text-center text-gray-500 py-4">Chưa có học sinh nào trong lớp. Hãy thêm học sinh mới.</p>}
              </ul>
            </div>

            <div className="fixed bottom-6 right-6 flex flex-col items-center gap-3 z-20">
                <button 
                  onClick={handleDeleteSelected} 
                  disabled={selectedStudentIds.length === 0}
                  className="group relative flex items-center justify-center w-14 h-14 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed transition-all"
                  aria-label="Xoá học sinh đã chọn"
                >
                  <TrashIcon className="w-7 h-7" />
                  <span className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap">
                      Xoá đã chọn ({selectedStudentIds.length})
                  </span>
                </button>
                <button 
                  onClick={handleImportStudentsClick} 
                  className="group relative flex items-center justify-center w-14 h-14 bg-purple-500 text-white rounded-full shadow-lg hover:bg-purple-600 transition-all"
                  aria-label="Nhập từ file"
                >
                  <UploadIcon className="w-7 h-7" />
                  <span className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2">
                      Nhập từ file
                  </span>
                </button>
                <button 
                  onClick={() => setIsModalOpen(true)} 
                  className="group relative flex items-center justify-center w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-all"
                  aria-label="Thêm học sinh mới"
                >
                  <PlusIcon className="w-7 h-7" />
                   <span className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2">
                      Thêm học sinh
                  </span>
                </button>
            </div>
            
            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Thêm học sinh mới">
              <div className="space-y-4">
                <div>
                  <label htmlFor="studentName" className="block text-sm font-medium text-gray-700 mb-1">Họ và tên học sinh</label>
                  <input type="text" id="studentName" value={newStudentName} onChange={e => setNewStudentName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Nguyễn Văn A"/>
                </div>
                <div className="flex justify-end space-x-2 pt-2">
                  <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Hủy</button>
                  <button onClick={handleAddStudent} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Thêm</button>
                </div>
              </div>
            </Modal>
          </div>
        );
      };

      // --- From pages/StudentDetailPage.tsx ---
      const StudentDetailPage = ({ classId, studentId }) => {
        const { classrooms, navigateToClass, updateStudent, addSingleAttendanceRecord, updateAttendanceRecord, deleteAttendanceRecord } = useAppContext();
        const { classroom, student } = useMemo(() => {
          const classroom = classrooms.find(c => c.id === classId);
          const student = classroom?.students.find(s => s.id === studentId);
          return { classroom, student };
        }, [classrooms, classId, studentId]);

        const [isEditing, setIsEditing] = useState(false);
        const [editedName, setEditedName] = useState(student?.name || '');
        const [editedNotes, setEditedNotes] = useState(student?.generalNotes || '');
        const [isRecordModalOpen, setRecordModalOpen] = useState(false);
        const [currentRecord, setCurrentRecord] = useState(null);

        if (!classroom || !student) {
          return <div className="p-4 text-center text-red-500">Học sinh hoặc lớp học không tìm thấy.</div>;
        }
        
        const handleSaveDetails = () => {
          updateStudent(classId, studentId, editedName, editedNotes);
          setIsEditing(false);
        };
        const openNewRecordModal = () => {
          setCurrentRecord({ date: new Date().toISOString().split('T')[0], note: '' });
          setRecordModalOpen(true);
        };
        const openEditRecordModal = (record) => {
          setCurrentRecord(record);
          setRecordModalOpen(true);
        };
        const handleSaveRecord = () => {
          if (!currentRecord || !currentRecord.date || !currentRecord.note) return;
          if(currentRecord.id) {
            updateAttendanceRecord(classId, studentId, currentRecord.id, currentRecord.date, currentRecord.note);
          } else {
            addSingleAttendanceRecord(classId, studentId, currentRecord.date, currentRecord.note);
          }
          setRecordModalOpen(false);
          setCurrentRecord(null);
        };

        return (
          <div className="p-4 sm:p-6 lg:p-8">
            <header className="flex items-center justify-between mb-6">
              <button onClick={() => navigateToClass(classId)} className="flex items-center text-blue-600 hover:text-blue-800 font-medium">
                <ChevronLeftIcon className="w-5 h-5 mr-1" />
                Trở lại danh sách lớp
              </button>
            </header>
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <div className="flex justify-between items-start">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-800">{student.name}</h1>
                      <p className="text-sm text-gray-500">Lớp: {classroom.name}</p>
                  </div>
                  {!isEditing && (
                      <button onClick={() => setIsEditing(true)} className="flex items-center px-3 py-1.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">
                          <EditIcon className="w-4 h-4 mr-1" /> Sửa
                      </button>
                  )}
              </div>
              {isEditing ? (
                  <div className="mt-4 space-y-4">
                      <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                          <input type="text" value={editedName} onChange={e => setEditedName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md"/>
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Ghi chú chung</label>
                          <textarea value={editedNotes} onChange={e => setEditedNotes(e.target.value)} rows={3} className="w-full p-2 border border-gray-300 rounded-md"></textarea>
                      </div>
                      <div className="flex space-x-2">
                          <button onClick={handleSaveDetails} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu thay đổi</button>
                          <button onClick={() => setIsEditing(false)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Hủy</button>
                      </div>
                  </div>
              ) : (
                  <div className="mt-4">
                      <h3 className="font-semibold text-gray-700">Ghi chú chung:</h3>
                      <p className="text-gray-600 mt-1 whitespace-pre-wrap">{student.generalNotes || 'Không có ghi chú.'}</p>
                  </div>
              )}
            </div>
            <div className="bg-white rounded-lg shadow-md p-6">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h2 className="text-xl font-bold text-gray-800">Lịch sử điểm danh</h2>
                  <p className="text-gray-600">Tổng số buổi có ghi chú: {student.attendance.length}</p>
                </div>
                <button onClick={openNewRecordModal} className="flex items-center px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                  <PlusIcon className="w-5 h-5 mr-2" /> Thêm ghi chú
                </button>
              </div>
              <div className="space-y-3">
                {student.attendance.length > 0 ? (
                  [...student.attendance].sort((a, b) => b.date.localeCompare(a.date)).map(record => (
                    <div key={record.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-md border">
                      <div className="flex items-center">
                        <CalendarIcon className="w-5 h-5 mr-3 text-gray-500"/>
                        <div>
                          <p className="font-semibold text-gray-800">{record.date}</p>
                          <p className="text-gray-600">{record.note}</p>
                        </div>
                      </div>
                      <div className="flex space-x-2">
                        <button onClick={() => openEditRecordModal(record)} className="p-1.5 text-gray-500 hover:text-blue-600"><EditIcon className="w-5 h-5"/></button>
                        <button onClick={() => deleteAttendanceRecord(classId, studentId, record.id)} className="p-1.5 text-gray-500 hover:text-red-600"><TrashIcon className="w-5 h-5"/></button>
                      </div>
                    </div>
                  ))
                ) : (
                  <p className="text-center text-gray-500 py-4">Chưa có ghi chú điểm danh nào.</p>
                )}
              </div>
            </div>
            <Modal isOpen={isRecordModalOpen} onClose={() => setRecordModalOpen(false)} title={currentRecord?.id ? "Sửa ghi chú" : "Thêm ghi chú mới"}>
              <div className="space-y-4">
                  <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Ngày</label>
                      <input type="date" value={currentRecord?.date || ''} onChange={e => setCurrentRecord(prev => ({...prev, date: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md"/>
                  </div>
                  <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Nội dung ghi chú</label>
                      <input type="text" placeholder="Vắng có phép, đi trễ,..." value={currentRecord?.note || ''} onChange={e => setCurrentRecord(prev => ({...prev, note: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md"/>
                  </div>
                  <div className="flex justify-end space-x-2 pt-2">
                      <button onClick={() => setRecordModalOpen(false)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Hủy</button>
                      <button onClick={handleSaveRecord} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button>
                  </div>
              </div>
            </Modal>
          </div>
        );
      };

      // --- From App.tsx ---
      const LoadingSpinner = () => (
          <div className="flex items-center justify-center h-screen">
              <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
          </div>
      );
      const AppContent = () => {
          const { view, isLoading, error } = useAppContext();
          if (isLoading) return <LoadingSpinner />;
          if (error) return <div className="p-4 text-center text-red-500 bg-red-100 rounded-md m-4">{error}</div>;
          
          const renderContent = () => {
              switch (view.page) {
                  case 'classDetails':
                      return view.classId ? <StudentListPage classId={view.classId} /> : <MainPage />;
                  case 'studentDetails':
                      return (view.classId && view.studentId) ? <StudentDetailPage classId={view.classId} studentId={view.studentId} /> : <MainPage />;
                  case 'main':
                  default:
                      return <MainPage />;
              }
          };
          return (
              <div className="min-h-screen bg-slate-50">
                  <main>{renderContent()}</main>
              </div>
          );
      }
      const App = () => {
        return (
          <AppProvider>
              <div className="antialiased text-slate-800">
                  <header className="bg-white shadow-sm sticky top-0 z-10">
                      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                          <div className="flex items-center justify-between h-16">
                              <h1 className="text-2xl font-bold text-blue-600">TeachApp</h1>
                              <p className="text-sm text-gray-500">Ứng dụng điểm danh học sinh</p>
                          </div>
                      </div>
                  </header>
                  <AppContent />
              </div>
          </AppProvider>
        );
      };

      // --- From index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );

      // --- End of Consolidated Code ---
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(error => {
              console.error('Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>